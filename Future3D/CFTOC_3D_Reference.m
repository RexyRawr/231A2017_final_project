function [feas, xOpt, uOpt, JOpt] = solveOPTOriginal(x0, step, T, xT)
g = 9.81;
m = 288773.23;
Ix = 24675886.69;
Iy = 44877574.15;
Iz = 67384152.12;
Ixz = 1315143.41;

% Define state matrix
sizex = 15;
sizeu = 6;
z = sdpvar(sizex,step+1);
% assign(z(:,1),x0);

% Define decision variables
u = sdpvar(sizeu,step);

% z = [u, v, w, p, q, r, x, y, z, theta, phi, psi, d1, d2, d3]
% u = [X, Y, Z, L, M, N]

constraints = [z(1:12,1)==x0];
tic

for i = 1:step
   
    if i ~= 1
        objective = objective+abs(T*u(1,i)*z(1,i))+abs(T*u(2,i)*z(2,i))+abs(T*u(3,i)*z(3,i));
    else
        objective = abs(T*u(1,i)*z(1,i))+abs(T*u(2,i)*z(2,i))+abs(T*u(3,i)*z(3,i));
    end
    
%     objective = abs(T*u(1,i)*z(1,i))+abs(T*u(2,i)*z(2,i))+abs(T*u(3,i)*z(3,i));
    
    constraints = [constraints,... 
        (z(2,i)^2+z(3,i)^2+z(1,i)^2)>=5184,...
        (z(2,i)^2+z(3,i)^2+z(1,i)^2)<=90000,...
        z(4,i)<=(10*pi/180),...
        z(4,i)>=(-10*pi/180),...
        z(5,i)<=(10*pi/180),...
        z(5,i)>=(-10*pi/180),...
        z(6,i)<=(10*pi/180),...
        z(6,i)>=(-10*pi/180),...
        z(9,i)>=0,...
        z(10,i)<=(50*pi/180),...
        z(10,i)>=(-50*pi/180),...
        z(11,i)<=(45*pi/180),...
        z(11,i)>=(-45*pi/180),...
        z(1,i+1)==z(1,i)+T*(u(1,i)/m-g*sin(z(10,i))-z(5,i)*z(3,i)+z(6,i)*z(2,i)),...
        z(2,i+1)==z(2,i)+T*(u(2,i)/m+g*cos(z(10,i))*sin(z(11,i))-z(6,i)*z(1,i)+z(4,i)*z(3,i)),...
        z(3,i+1)==z(3,i)+T*(u(3,i)/m+g*cos(z(10,i))*cos(z(11,i))-z(4,i)*z(2,i)+z(5,i)*z(1,i)),...
        z(13,i)==(z(1,i+1)-z(1,i)),...
        z(14,i)==(z(2,i+1)-z(2,i)),...
        z(15,i)==(z(3,i+1)-z(3,i)),...
        z(13,i)<=9.81*T,...
        z(14,i)<=9.81*T,...
        z(15,i)<=4*9.81*T,...
        z(13,i)>=-9.81*T,...
        z(14,i)>=-9.81*T,...
        z(15,i)>=-2*9.81*T,...
        z(4,i+1)==z(4,i)+T*(Iz*u(4,i)+Ixz*u(6,i)-z(5,i)*(Ixz*z(4,i)*(Iy-Ix-Iz)+z(6,i)*(Ixz^2+Iz*(Iz-Iy))))/(Ix*Iz-Ixz^2),...
        z(5,i+1)==z(5,i)+T*(u(5,i)-z(4,i)*z(6,i)*(Ix-Iz)-Ixz*(z(4,i)^2-z(6,i)^2))/Iy,...
        z(6,i+1)==z(6,i)+T*(Ixz*u(4,i)+Ixz*u(6,i)-z(5,i)*(Ixz*z(4,i)*(Iy-Ix-Iz)+z(4,i)*(Ixz^2+Ix*(Ix-Iy))))/(Ix*Iz-Ixz^2),...
%         z(7,i+1)==z(7,i)+T*(cos(z(12,i))*cos(z(10,i))*z(1,i)+(-sin(z(12,i))*cos(z(11,i))+cos(z(12,i))*sin(z(10,i))*sin(z(11,i)))*z(2,i)+(sin(z(12,i))*sin(z(11,i))+cos(z(12,i))*cos(z(11,i))*sin(z(10,i)))*z(3,i)),...
%         z(8,i+1)==z(8,i)+T*(sin(z(12,i))*cos(z(10,i))*z(1,i)+(cos(z(12,i))*cos(z(11,i))+sin(z(11,i))*sin(z(10,i))*sin(z(12,i)))*z(2,i)+(-cos(z(12,i))*sin(z(11,i))+sin(z(10,i))*sin(z(12,i))*cos(z(11,i)))*z(3,i)),...
%         z(9,i+1)==z(9,i)+T*(-sin(z(10,i))*z(1,i)+cos(z(10,i))*sin(z(11,i))*z(2,i)+cos(z(10,i))*cos(z(11,i))*z(3,i)),...
        z(7, i+1)==z(7, i)+T*z(1,i),...
        z(8, i+1)==z(8, i)+T*z(2,i),...
        z(9, i+1)==z(9, i)+T*z(3,i),...
%         z(10,i+1)==z(10,i)+T*(cos(z(11,i))*z(5,i)-sin(z(11,i))*z(6,i)),...
%         z(11,i+1)==z(11,i)+T*(z(4,i)+sin(z(11,i))*tan(z(10,i))*z(5,i)+cos(z(11,i))*tan(z(10,i))*z(6,i)),...
%         z(12,i+1)==z(12,i)+T*((sin(z(11,i))/cos(z(10,i)))*z(5,i)+(cos(z(11,i))/cos(z(10,i)))*z(6,i)),...
        z(10, i+1)==z(10, i)+T*z(5,i),...theta(pitch), q
        z(11, i+1)==z(11, i)+T*z(4,i),...phi(roll), p
        z(12, i+1)==z(12, i)+T*z(6,i),...psi(heading/yaw), r
        ];
    
    
end

constraints = [constraints,...
    z(7,step+1)>=xT(1);...
    z(7,step+1)<=xT(1)+1000;...
    z(8,step+1)==xT(2);...
    z(9,step+1)==xT(3);...
    z(10,step+1)==pi/36;...
    z(11,step+1)==0;...
    z(12,step+1)==0;...
    z(4,step+1)==0;...
    z(5,step+1)==0;...
    z(6,step+1)==0;...
    z(1,step+1)>=0,...
    z(1,step+1)<=72*1.05,...
    z(2,step+1)==0;...
    z(3,step+1)==0];



% Set options for YALMIP and solver
options = sdpsettings('verbose',1,'solver','ipopt');

% Solve
sol = optimize(constraints, objective, options);

% Retrieve solutions
opt_z = value(z);
opt_u = value(u);
opt_J = value(objective);

% xOpt = opt_z(7:12, :);
xOpt = opt_z;
uOpt = opt_u;
JOpt = opt_J;
feas = true;

if sol.problem == 1
    feas = false;
    xOpt = [];
    uOpt = [];
    JOpt = [];
end

time = toc;
fprintf('%f\n', time)



end

% velocity
% u >= 72;

% acceleration
% (u(k+1) - u(k)) / T <= g
% (v(k+1) - v(k)) / T <= g / 10
% (w(k+1) - w(k)) / T <= g / 10

% angles
% pitching
% theta <= 25 * pi / 180
% theta >= -10 * pi / 180

% rolling
% phi <= 45 * pi / 180
% phi >= -45 * pi / 180

% yawing approximated
% psi >= -5 * pi / 180
% psiMax <= 5 * pi / 180


% terminal
% xT = 0;
% yT = 0;
% zT = 0;
% uT = 72*1.05